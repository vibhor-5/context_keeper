# Docker Compose configuration for ContextKeeper MCP + Slack Bot
version: '3.8'

services:
  # ContextKeeper MCP + Slack Bot Service
  contextkeeper-mcp-slack:
    build:
      context: .
      dockerfile: Dockerfile.mcp-slack
    container_name: contextkeeper-mcp-slack
    restart: unless-stopped
    ports:
      - "3001:3001"  # MCP Server
      - "3002:3002"  # Slack Bot
      - "8080:8080"  # Health/Monitoring
    environment:
      # Node.js environment
      - NODE_ENV=production
      - LOG_LEVEL=info
      
      # MCP Server configuration
      - MCP_PORT=3001
      - MCP_GO_BACKEND_URL=http://contextkeeper-backend:3000
      - MCP_TIMEOUT=30000
      - MCP_CORS_ORIGINS=*
      
      # Slack Bot configuration
      - SLACK_PORT=3002
      - SLACK_SIGNING_SECRET_FILE=/run/secrets/slack_signing_secret
      - SLACK_MCP_SERVER_URL=http://localhost:3001
      - SLACK_MAX_RESPONSE_LENGTH=4000
      - SLACK_RETRY_ATTEMPTS=3
      - SLACK_RETRY_DELAY=1000
      - SLACK_DEFAULT_REPOSITORY=demo-repo
      
      # Health server configuration
      - HEALTH_PORT=8080
      
      # Demo mode configuration
      - DEMO_MODE=false
      - DEMO_PREDICTABLE_RESPONSES=true
      - DEMO_FALLBACK_ON_ERROR=true
    
    secrets:
      - slack_signing_secret
    
    volumes:
      # Logs volume
      - contextkeeper-mcp-logs:/app/logs
      # Data volume for demo data persistence
      - contextkeeper-mcp-data:/app/data
    
    networks:
      - contextkeeper-network
    
    depends_on:
      - contextkeeper-backend
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080/health', (res) => { if (res.statusCode === 200) process.exit(0); else process.exit(1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ContextKeeper Go Backend (external dependency)
  contextkeeper-backend:
    image: contextkeeper/backend:latest
    container_name: contextkeeper-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - DATABASE_URL=postgres://contextkeeper:password@postgres:5432/contextkeeper
      - GITHUB_CLIENT_ID_FILE=/run/secrets/github_client_id
      - GITHUB_CLIENT_SECRET_FILE=/run/secrets/github_client_secret
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - AI_SERVICE_URL=http://ai-service:8000
    secrets:
      - github_client_id
      - github_client_secret
      - jwt_secret
    networks:
      - contextkeeper-network
    depends_on:
      - postgres

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: contextkeeper-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=contextkeeper
      - POSTGRES_USER=contextkeeper
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    secrets:
      - postgres_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - contextkeeper-network
    ports:
      - "5432:5432"

  # AI Service (mock for demo)
  ai-service:
    image: nginx:alpine
    container_name: contextkeeper-ai-service
    restart: unless-stopped
    ports:
      - "8000:80"
    networks:
      - contextkeeper-network
    volumes:
      - ./ai-service-mock.conf:/etc/nginx/conf.d/default.conf:ro

# Secrets
secrets:
  slack_signing_secret:
    file: ./secrets/slack_signing_secret.txt
  github_client_id:
    file: ./secrets/github_client_id.txt
  github_client_secret:
    file: ./secrets/github_client_secret.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  postgres_password:
    file: ./secrets/postgres_password.txt

# Volumes
volumes:
  contextkeeper-mcp-logs:
    driver: local
  contextkeeper-mcp-data:
    driver: local
  postgres-data:
    driver: local

# Networks
networks:
  contextkeeper-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16